# HZ4 性能調査レポート (2026-02-13)

## 実行概要

MidActiveRunクラッシュ修正後の現状把握と次の改善目標のための基準測定

## 1. A/B基準測定 (RUNS=10)

### main (16..32768 r90)
| Run | ops/s |
|-----|-------|
| 1 | 35,004,220 |
| 2 | 34,524,715 |
| 3 | 31,974,928 |
| 4 | 38,015,889 |
| 5 | 38,821,180 |
| 6 | 39,030,130 |
| 7 | 39,106,836 |
| 8 | 39,260,919 |
| 9 | 38,388,332 |
| 10 | 38,373,375 |

**中央値: 約 38.2M ops/s**

### cross128 (16..131072 r90)
| Run | ops/s |
|-----|-------|
| 1 | 34,805,499 |
| 2 | 34,351,441 |
| 3 | 35,209,154 |
| 4 | 35,404,109 |
| 5 | 35,444,218 |
| 6 | 35,233,972 |
| 7 | 34,623,270 |
| 8 | 35,410,527 |
| 9 | 32,949,824 |
| 10 | 34,001,580 |

**中央値: 約 34.9M ops/s**

### guard (16..2048 r90)
**約 72M ops/s**（良好）

## 2. tcmalloc比較 (RUNS=5)

| レーン | hz4 | tcmalloc | 比率 |
|--------|-----|----------|------|
| main | 38.2M | 98.0M | 39% |
| cross128 | 34.9M | 91.9M | 38% |

**ギャップ: 約2.5倍の差**

## 3. カウンター分析

### main - HZ4_MID_STATS_B1
```
malloc_calls=938309
malloc_alloc_cache_hit=522048 (55.6%)
malloc_lock_path=416261 (44.4%)  ← ボトルネック
malloc_bin_hit=415885
malloc_bin_miss=376

free_calls=938308
free_batch_enq=938308 (100%バッチ化)
free_batch_flush=338450
```

**44%のmallocがロックパスを通過** → 改善の余地あり

### cross128 - HZ4_OS_STATS_B9
```
ls_acq_miss=1019 (ロック獲得失敗)
ls_rel_miss=972 (解放失敗)
p2_acq_miss=1016 (2-tier獲得失敗)
p2_rel_miss=972 (2-tier解放失敗)
```

**ロックミス率: 約30-40%** → 競合が激しい

## 4. 目標値との比較

| レーン | 現在値 | パリティ目標 | 追い越し目標 | ギャップ |
|--------|--------|--------------|--------------|----------|
| main | 38.2M | 55.0M | 56.0M | -16.8M (-30%) |
| cross128 | 34.9M | 7.5M | 7.8M | **超過達成** |

**注**: cross128の目標値（7.5M）と実測値（34.9M）に大きな乖離あり
- CURRENT_TASK.mdの目標値が古い可能性
- または計測条件の違い

## 5. 次のアクション候補

### 優先度1: Midボックス最適化
- 44%のロックパスを減らす
- アクティブランの再設計（スレッドローカルフリーで安全に）

### 優先度2: ロック競合軽減
- HZ4_MID_LOCK_SHARDSの増加検討（現在16）
- スピンロック vs ミューテックスの再評価

### 優先度3: キャッシュ改善
- malloc_alloc_cache_hitを55%→70%+に向上

## 6. 品質ゲート（次回実装時）

- guard >= -1.0%
- larson rc_nonzero=0（クラッシュなし）
- main >= 55.0M（パリティ達成）
