# S30: dist=app gap の "tail cost" 分解結果

## Status: COMPLETED (主犯確定)

Date: 2026-01-02

## 背景

S29 で確定した hz3 vs tcmalloc の gap:
- dist=app: **-7.69%** ← 最大
- uniform: -4.47%
- tiny: -1.56%

dist=app が最大の gap を示したため、S30 では「tail (5%) のどのレンジが主犯か」を triage した。

## 結果サマリ

### 2章: Tail-only (100%) RUNS=30

| Range (bytes) | hz3 median | tcmalloc median | Delta |
|---------------|------------|-----------------|-------|
| 2049–4095     | 6,150,882  | 6,185,697       | **-0.56%** |
| 4096–8191     | 6,161,757  | 6,197,744       | **-0.58%** |
| 8192–16384    | 6,056,543  | 6,095,985       | **-0.65%** |
| 16385–32768   | 6,018,555  | 6,060,000       | **-0.68%** |

**発見**: 全レンジがほぼ同じ（~0.6%）。突出して遅いレンジはない。

### 3章: App-shaped (80/15/5) 形を固定、tail レンジだけ差し替え

| Tail Range    | hz3 median | tcmalloc median | Delta |
|---------------|------------|-----------------|-------|
| 2049–4095     | 6,184,320  | 6,204,202       | **-0.32%** |
| 4096–8191     | 6,191,078  | 6,230,176       | **-0.63%** |
| 8192–16384    | 6,137,612  | 6,150,537       | **-0.21%** |
| 16385–32768   | 6,033,422  | 6,052,817       | **-0.32%** |

**発見**: app 形でも全レンジが 0.2–0.6%。dist=app の -7.69% にはほど遠い。

## 分析

### 主犯はtailではない

| Workload | Gap | 説明 |
|----------|-----|------|
| dist=app (80/15/5) | -7.69% | 本来の app 分布 |
| tiny (16–256 only) | -1.56% | 80% を占める小サイズ |
| tail-only (各レンジ) | ~-0.6% | 5% の tail 単独 |
| app形+tail差替 | ~-0.4% | 80/15/5 で tail レンジ変更 |

**矛盾**:
- tiny 単独: -1.56%
- tail 単独: ~-0.6%
- しかし dist=app 全体: -7.69%

単純に重み付け平均すると: `0.80 × 1.56 + 0.15 × ??? + 0.05 × 0.6 ≈ 1.28 + ??? + 0.03`

dist=app が -7.69% なので、**15% mid-range (257–2048)** または **サイズ遷移の固定費** が犯人と推測される。

### 仮説: サイズ遷移のオーバーヘッド

- app 分布では 80/15/5 で常に **サイズクラスが混在**
- malloc/free のたびに「どの bin か」の判定が走る
- tiny-only や tail-only では bin 判定がほぼ固定（キャッシュが効く）
- **mixed 環境での bin 遷移コスト** が実は主犯の可能性

## 結論: 主犯レンジ

**「tail レンジに特定の主犯はない」**

- tail (2049–32768) の各レンジは全て ~0.6% 程度で横並び
- tail を 5% から 100% にしても gap は大きくならない
- dist=app の -7.69% は tail が原因ではない

**次の疑いポイント**:
1. **mid-range (257–2048)** の 15% が意外と重い可能性
2. **mixed-size 環境での bin 判定固定費** が支配的
3. **tiny (16–256) の 80%** が実は -1.56% 以上ある可能性（他のサイズと混在時）

## 次の箱 (S31 候補)

S30 は「tail が主犯」という仮説を **棄却** した。

S31 では:
- **オプションA**: mid-range (257–2048) を 100% で単独計測し、gap を確認
- **オプションB**: perf record で dist=app の hotspot を直接観測し、bin 判定/遷移コストを特定
- **オプションC**: tiny-only vs tiny+mid vs tiny+mid+tail の累積効果を計測し、interaction を特定

推奨: **オプションB** (perf record で直接観測) → 推測を減らして SSOT で決める

## ログ

- `/tmp/s30_tail_sub4k/` - Tail-only 2049–4095
- `/tmp/s30_tail_sub8k/` - Tail-only 4096–8191
- `/tmp/s30_tail_8_16k/` - Tail-only 8192–16384
- `/tmp/s30_tail_16_32k/` - Tail-only 16385–32768
- `/tmp/s30_app_tail_sub4k/` - App-shaped tail=2049–4095
- `/tmp/s30_app_tail_sub8k/` - App-shaped tail=4096–8191
- `/tmp/s30_app_tail_8_16k/` - App-shaped tail=8192–16384
- `/tmp/s30_app_tail_16_32k/` - App-shaped tail=16385–32768
