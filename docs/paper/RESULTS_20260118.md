# Results (2026-01-18)

Scope: paper-facing results snapshot, stored as raw data notes for later curation
into `docs/paper/ACE-Alloc/main.md`.

Environment
- CPU: AMD Ryzen 9 9950X (16C/32T)
- OS: WSL2 Linux 5.15.167.4-microsoft-standard-WSL2
- git: e165faccc (dirty)

Environment (Native Linux, Zen3)
- CPU: AMD Ryzen 7 5825U (8C/16T)
- OS: Ubuntu 22.04, kernel 6.8.0-90-generic
- GCC: 11.4.0
- glibc: 2.35
- git: 33f7eb4d2 (copied workspace; native run)

Note
- Primary evaluation uses WSL2 (Ryzen 9950X, 16C/32T) for higher thread scaling.
- Native Linux (Ryzen 7 5825U) results are included as sanity checks only.

## Memcached + memtier_benchmark (Linux, WSL2)

Versions
- memcached 1.6.40 (source: `hakozuna/bench/linux/memcached`)
- memtier_benchmark 2.2.1 (source: `hakozuna/bench/linux/memtier_benchmark`)

Commands
```
memcached -p 11211 -U 0 -t 4 -m 1024 -l 127.0.0.1
for T in 1 4 8 16; do
  memtier_benchmark --protocol=memcache_text --server=127.0.0.1 --port=11211 \
    --threads=$T --clients=50 --ratio=1:1 --data-size=64 --key-maximum=100000 \
    --hide-histogram --test-time=10 --run-count=3
done
```

Allocators
- system: no LD_PRELOAD
- hz3: `LD_PRELOAD=/home/tomoaki/git/hakmem/libhakozuna_hz3_scale.so`
- mimalloc: `LD_PRELOAD=/lib/x86_64-linux-gnu/libmimalloc.so.2`
- tcmalloc: `LD_PRELOAD=/lib/x86_64-linux-gnu/libtcmalloc_minimal.so.4`

Results (Totals line, median of 3 runs)
```
T=1  system   269430 (0.190 ms)  hz3 269441 (0.187 ms)  mimalloc 264036 (0.190 ms)  tcmalloc 263658 (0.190 ms)
T=4  system   970654 (0.209 ms)  hz3 962938 (0.208 ms)  mimalloc 971758 (0.212 ms)  tcmalloc 986403 (0.204 ms)
T=8  system  1373595 (0.292 ms)  hz3 1424294 (0.288 ms)  mimalloc 1441268 (0.287 ms) tcmalloc 1379915 (0.293 ms)
T=16 system  1487842 (0.546 ms)  hz3 1513693 (0.543 ms)  mimalloc 1515587 (0.534 ms)  tcmalloc 1498018 (0.534 ms)
```

Notes
- p50/p99 latencies are effectively identical across allocators (~0.20ms / ~0.53ms).
- memcached uses its own slab allocator; allocator deltas are expected to be small.
- T=8 was re-run (RUNS=5) to remove a prior avg latency outlier.

Logs
- `/tmp/hz3_paper_bench_full_20260119_235015/memcached_short/`
- `/tmp/hz3_paper_bench_full_20260119_235015/memcached_t8_rerun/`

## Native Linux sanity check (Zen3, Ryzen 7 5825U)

Logs (copied)
- `/home/tomoaki/git/hakmem/docs/paper/ACE-Alloc/native bench/paper_20260118`

SSOT bench (RUNS=10, ITERS=20M, WS=400)
- small (16-2048): ~89-91M ops/s
- medium (4096-32768): ~13.6-13.9M ops/s (glibc, no LD_PRELOAD)
- medium (4096-32768): ~92-94M ops/s (hz3, LD_PRELOAD)
- mixed (16-32768): ~83-87M ops/s

Notes
- medium range is large allocation: glibc uses mmap/munmap heavily, while hz3 uses S50/S51/S52 large cache to reduce syscalls.

MT remote
- T=8 R=90%: 49.9M ops/s (actual remote 90.0%)
- T=16 R=50%: 85.1M ops/s (actual remote 50.0%)
- Logs: `/tmp/hz3_mt_remote_t8_r90.log`, `/tmp/hz3_mt_remote_t16_r50.log`

Larson
- T=1: 24.5M ops/s
- T=8: 99.7M ops/s (4.06x scaling)
- T=16: 112.4M ops/s (4.58x scaling)
- Logs: `/tmp/hz3_larson_t{1,8,16}.log`

## Redis workload_bench_system perf (Linux, WSL2)

Command
```
taskset -c 0-7 ./benchmarks/redis/workload_bench_system 4 500 2000 16 256
```

Note
- Redis latency in `paper_full_20260120` is derived from `redis-cli --latency --latency-history`; p50/p95/p99 are approximate (not strict quantiles).

Throughput (range across 5 runs, hz3 vs tcmalloc)
```
pattern  hz3            tcmalloc        delta
SET      5.07-5.25M     4.53-4.99M      +5-10%
GET      4.88-5.25M     4.53-4.97M      +5-10%
LPUSH    4.91-5.26M     4.54-5.01M      +5-10%
LPOP     4.88-5.27M     4.23-4.80M      +10-15%
RANDOM   4.86-5.26M     4.22-4.85M      +10-15%
```

perf stat (median-like values from -r 5)
```
metric          hz3      tcmalloc   delta
time            2.02s    2.22s      -9.0%
instructions    17.29B   16.89B     +2.4%
cycles          8.42B    9.22B      -8.6%
IPC             2.05     1.83       +12.0%
branch miss %   0.65%    0.70%      -7.1%
L1 miss %       1.03%    1.53%      -32.7%
L1 misses       78.5M    119.9M     -34.5%
dTLB miss %     32.29%   39.02%     -17.2%
```

perf record (hz3 only)
- Top: `rand()`/`__random`/`__lll_lock_*` ~71.7%, `__snprintf_chk` ~20.5%
- Allocator internals do not dominate the profile under this benchmark; deltas
  appear primarily via cache behavior (L1 miss reduction).

Logs
- `/tmp/perf_stat_hz3_redis_fixed.txt`
- `/tmp/perf_stat_tc_redis.txt`
- `/tmp/perf_redis_hz3_fixed.data`
- `/tmp/perf_redis_hz3_fixed_top.txt`

## Windows bench_mixed_ws compare (Windows native)

Command (PowerShell)
```
powershell -ExecutionPolicy Bypass -File .\hakozuna\hz3\win\build_win_bench_compare.ps1
```

Bench
- `bench_mixed_ws` (CRT / hz3 / mimalloc / tcmalloc)
- Params: `threads=4 iters=1000000 ws=8192 size=16..1024`
- RUNS=5, median ops/s

Results
```
allocator  ops/s (median)
CRT        39.91M
hz3        341.22M
mimalloc   252.16M
tcmalloc   272.20M
```

## SSOT-LDP random_mixed (Linux, WSL2)

Benchmark
- `system_bench_random_mixed` (from `bench_random_mixed.c`)
- Params: `ITERS=20,000,000`, `WS=400`, `RUNS=10`
- RSS: `getrusage(RUSAGE_SELF).ru_maxrss` in KB (printed as `[RSS] max_kb=...`)

Classic tcmalloc (gperftools) run
- tcmalloc: 134.6 M ops/s (median), RSS 7.8 MB
- hz3: 132.6 M ops/s (median), RSS 3.0 MB
- mimalloc: 130.2 M ops/s (median), RSS 2.1 MB
- system: 108.5 M ops/s (median), RSS 2.0 MB

google tcmalloc run (LD_PRELOAD build)
- tcmalloc (google): 14.3 M ops/s (median), RSS 11.6 MB
- Note: anomalously slow (~1/9 of hz3). This result is treated as
  inconclusive for now; likely needs a link-mode build or tuning.

Logs
- `bench_results/hakozuna_compare_20260118_034554/` (google tcmalloc)
- `/tmp/google_tcmalloc_linkmode_runs10/` (google tcmalloc, link-mode)

google tcmalloc run (link-mode)
- tcmalloc (google): 14.32 M ops/s (median), RSS 11.6 MB
- Note: link-mode matches LD_PRELOAD result (+0.14%). Still anomalously slow.

## MT remote quick sweep (Linux, WSL2)

Benchmark
- `bench_random_mixed_mt_remote_malloc`
- Params: `ITERS=1,000,000`, `RUNS=3`, `sizes=16..2048`, `WS=400`

Results (median ops/s)
```
T=8  R=50  hz3 130.8M  mimalloc 138.2M  classic_tcmalloc 129.0M
T=8  R=90  hz3 132.2M  mimalloc  83.7M  classic_tcmalloc 131.5M
T=16 R=50  hz3 209.8M  mimalloc 179.9M  classic_tcmalloc 178.3M
T=16 R=90  hz3 129.7M  mimalloc 148.9M  classic_tcmalloc 133.3M
T=32 R=50  hz3 222.6M  mimalloc 258.3M  classic_tcmalloc 229.6M
T=32 R=90  hz3 155.6M  mimalloc 221.4M  classic_tcmalloc 146.0M
```

Notes
- Quick sweep only (RUNS=3). Use RUNS=10 for confirmation on key points.

Logs
- `/tmp/mt_remote_quick_20260118_042250/`

## MT remote Stage 2 (Linux, WSL2)

Benchmark
- `bench_random_mixed_mt_remote_malloc`
- Params: `ITERS=2,500,000`, `RUNS=10`, `sizes=16..2048`, `WS=400`

Results (median ops/s)
```
T=8  R=90  hz3 172.5M  mimalloc 134.6M  classic_tcmalloc 140.9M
T=16 R=50  hz3 240.7M  mimalloc 188.8M  classic_tcmalloc 196.2M
T=32 R=90  hz3 144.7M  mimalloc 181.1M  classic_tcmalloc 106.1M
```

google tcmalloc spot check
- T=32 R=90: 10.8 M ops/s (median)

Logs
- `/tmp/mt_remote_stage2_20260118_042723/`
- `/tmp/mt_remote_stage2_google_20260118_042828/`

## MT remote Stage 3 (Linux, WSL2, S149 ring=1024)

Benchmark
- `bench_random_mixed_mt_remote_malloc`
- Params: `ITERS=2,500,000`, `RUNS=10`, `sizes=16..2048`, `WS=400`, `ring_slots=262144`

Results (median ops/s)
```
T=8  R=90  hz3 193.1M  mimalloc 132.3M  classic_tcmalloc 153.0M
T=16 R=50  hz3 270.6M  mimalloc 208.6M  classic_tcmalloc 226.5M
T=32 R=90  hz3 198.8M  mimalloc 196.5M  classic_tcmalloc 147.6M
```

Notes
- `HZ3_REMOTE_STASH_RING_SIZE=1024`（S149）で overflow を大幅削減し、T=32/R=90 で **mimalloc を逆転（+1.2%）**。

Logs
- `/tmp/s149_bench/`

## Redis thread sweep (Linux, WSL2)

Benchmark
- `benchmarks/redis/workload_bench_system`
- Params: `C=500 O=2000 size=16..256`, `RUNS=5`

Results (median ops/s)
```
T=1  system 25.63  hz3 30.27  mimalloc 30.73  classic_tcmalloc 30.77  google_tcmalloc 10.47
T=4  system  1.99  hz3  4.14  mimalloc  4.17  classic_tcmalloc  4.10  google_tcmalloc  2.90
T=8  system  0.70  hz3  1.28  mimalloc  1.24  classic_tcmalloc  1.23  google_tcmalloc  1.05
T=16 system  0.34  hz3  0.29  mimalloc  0.29  classic_tcmalloc  0.27  google_tcmalloc  0.27
```

Notes
- T=16 shows a broad throughput collapse for all allocators (likely workload contention).
- hz3 is roughly on par with mimalloc/classic tcmalloc for T=1/4 and slightly ahead at T=8.

Logs
- `/tmp/redis_sweep_20260118_043330/`

## Larson sweep (Linux, WSL2)

Benchmark
- `mimalloc-bench/bench/larson/larson` (hygienic build)
- Params: `runtime=10s min=8 max=1024 chunks=10000 rounds=1 seed=12345`
- RUNS=5

Results (median ops/s)
```
T=1  hz3 30.32M  mimalloc 20.97M  tcmalloc 29.73M  system 7.07M
T=4  hz3 108.65M mimalloc 75.52M  tcmalloc 104.23M system 21.67M
T=8  hz3 191.96M mimalloc 135.67M tcmalloc 174.41M system 37.14M
T=16 hz3 297.82M mimalloc 216.72M tcmalloc 175.17M system 59.31M
```

Notes
- hz3 leads across all tested thread counts.

Logs
- `/tmp/hz3_paper_bench_full_20260119_235015/larson/`

## mimalloc-bench subset (Linux, WSL2)

Benchmark
- cache-thrash, cache-scratch, malloc-large
- RUNS=5

cache-thrash (median ops/s)
```
T=1   system 1216.15  hz3 1214.50  hakozuna 1219.06  mimalloc 1217.57  classic_tc 1215.26  google_tc 1150.82
T=32  system 330663   hz3 317975   hakozuna 325926   mimalloc 318780   classic_tc 307452   google_tc 247558
```

cache-scratch (median ops/s)
```
T=1   system 1368.00  hz3 1358.23  hakozuna 1341.65  mimalloc 1355.11  classic_tc 1332.26  google_tc 1279.85
T=32  system 349887   hz3 331512   hakozuna 346082   mimalloc 352775   classic_tc 337424   google_tc 251706
```

malloc-large (median ops/s)
```
allocator  classic_tc  google_tc
system     1993.86     2053.16
hz3        2599.13     2604.24
hakozuna    350.56      341.40
mimalloc   2067.03     2039.88
tcmalloc   2589.34     1455.32
```

Notes
- T=1: all allocators are within ~5%, google tcmalloc slightly lower.
- T=32: google tcmalloc drops 20-30% on cache-thrash/scratch.
- malloc-large: hz3 is fastest; google tcmalloc is notably slow.
- hakozuna is weak on malloc-large (large pool not optimized).

Logs
- classic tcmalloc: `/tmp/mimalloc_bench_subset_e165faccc_20260118_045649/`
- google tcmalloc: `/tmp/mimalloc_bench_subset_e165faccc_20260118_045800/`

## mimalloc-bench (time-based, Linux, WSL2)

Benchmark
- cache-scratch, cache-thrash, glibc-thread
- RUNS=5
- Unit: seconds (lower is better)

Results (median time, T=32)
```
cache-scratch  hz3 1.35s  mimalloc 1.34s  tcmalloc 1.28s  system 1.39s
cache-thrash   hz3 1.35s  mimalloc 1.35s  tcmalloc 1.32s  system 1.38s
glibc-thread   hz3 2.00s  mimalloc 2.00s  tcmalloc 2.00s  system 2.00s
```

Notes
- T=1 runs were ~1.73-1.76s across all allocators (near tie).
- T=32: hz3 is within ~1% of mimalloc; tcmalloc leads by ~3-8%.

## mimalloc-bench remaining (time + RSS, Linux, WSL2)

Benchmark
- alloc-test, espresso, barnes
- RUNS=5
- Time unit: seconds (lower is better)
- RSS: max_kb via getrusage(2)

alloc-test (median time)
```
system 2.86s  hz3 2.36s  mimalloc 2.23s  tcmalloc 2.25s
```

alloc-test (RSS)
```
system 19.6MB  hz3 28.9MB  mimalloc 72.4MB  tcmalloc 20.8MB
```

espresso (median time)
```
system 2.86s  hz3 2.52s  mimalloc 2.53s  tcmalloc 2.55s
```

espresso (RSS)
```
system 2.6MB  hz3 6.2MB  mimalloc 7.6MB  tcmalloc 10.7MB
```

barnes (median time)
```
system 1.44s  hz3 1.44s  mimalloc 1.43s  tcmalloc 1.45s
```

Notes
- hz3 is close to mimalloc/tcmalloc on time-based alloc-test/espresso, but uses more RSS than system/tcmalloc.
- barnes is close to a tie on this environment.

Logs
- `/tmp/hz3_paper_bench_full_20260119_235015/mimalloc_remaining.log`
- `hakozuna/bench/linux/mimalloc-bench/out/bench/benchres.csv`

## S153 (S44 prefetch dist=2)

Benchmark
- SSOT small/medium/mixed (RUNS=10, WS=400)
- xmalloc-test (remote-heavy)

Results (median ops/s)
```
small  153.84M  (range 149.38-154.97, CV 1.2%)
medium 148.07M  (range 144.59-153.88, CV 2.0%)
mixed  145.75M  (range 139.55-147.93, CV 1.9%)
```

Notes
- xmalloc-test: +5.0% with PREFETCH_DIST=2 (10/10 wins).
- No regressions observed on SSOT small/medium/mixed.

Logs
- `/tmp/hz3_ssot_20137d919_20260119_141824/`

## S154 (spill overflow prefetch)

Benchmark
- xmalloc-test (RUNS=10)
- SSOT small/medium/mixed (RUNS=10, WS=400)

Results
```
xmalloc-test  baseline 1.925s  S154 1.789s  (+7.06%)
small         150.49M  (vs S153 153.84M, -2.00%)
medium        154.27M  (vs S153 148.07M, +4.00%)
mixed         146.19M  (vs S153 145.75M, +0.30%)
```

Notes
- xmalloc-test improves by +7.06%.
- SSOT results stay within the -3% regression threshold.

## S155 (early prefetch dist=2) NO-GO

Benchmark
- MT remote (T=8/R=90, T=16/R=50)

Results
```
T=8 R=90  baseline 174.20M  dist=2 162.13M  (-6.92%)
T=16 R=50 baseline 219.25M  dist=2 205.10M  (-6.45%)
```

Notes
- Early prefetch dist=2 caused consistent regressions (cache pollution).
- Baseline restored to dist=1.

Logs
- `/tmp/s155_ab_test/REPORT.md`

## S160 (bestfit range=8) NO-GO

Benchmark
- SSOT small/medium/mixed (RUNS=10, WS=400)

Results
```
small  149.46M -> 146.29M  (-2.12%)
medium 150.47M -> 148.72M  (-1.16%)
mixed  143.64M -> 143.54M  (-0.07%)
```

Notes
- malloc-large showed ~-3.2% time improvement at range=8, but SSOT small regressed beyond the ±2% threshold.
- Keep default `HZ3_S52_BESTFIT_RANGE=4`.

Logs
- `/tmp/hz3_ssot_2b21a89f3_20260120_013046/` (baseline)
- `/tmp/hz3_ssot_2b21a89f3_20260120_013247/` (range=8)

## Final perf snapshot (T=1)

Benchmark
- `bench_random_mixed` (T=1)

Results
```
hz3      131.36M ops/s  RSS 4,864 KB
tcmalloc 132.60M ops/s  RSS 7,832 KB
```

Hardware counters (T=1)
```
metric           hz3     tcmalloc
IPC              1.68    1.69
branch miss %    4.25%   4.73%
L1 miss %        0.69%   0.40%
page faults      493     1,258
cycles/op        21.2    21.0
```

Notes
- T=1 throughput is within noise; hz3 uses ~38% less RSS.
- PTAG32 lookup raises L1 misses, but IPC is comparable.

Logs
- `/tmp/hz3_final_perf_snapshot.txt`

## Memcached thread sweep (Linux, WSL2)

Benchmark
- memcached 1.6.40 + memtier_benchmark 2.2.1
- Params: `test-time=20s`, `RUNS=5`, `threads=1/4/8/16`
- Each run uses `--run-count=1` and per-thread server ports.

Results (median ops/s, Totals)
```
T=1  hz3 278,109   mimalloc 283,697   classic_tcmalloc 280,453
T=4  hz3 816,008   mimalloc 741,478   classic_tcmalloc 809,366
T=8  hz3 1,298,515 mimalloc 1,301,294 classic_tcmalloc 1,304,450
T=16 hz3 1,487,819 mimalloc 1,471,710 classic_tcmalloc 1,374,252
```

Notes
- The quick sweep was invalid due to 0-ops runs; Stage 2 corrected this and shows
  hz3 leading at T=4 and T=16.

Logs
- `/tmp/memcached_sweep_stage2_20260118_054118/`

## S44 ablation (Linux, WSL2)

Benchmark
- alloc-test (MT, 6 threads)
- RUNS=5

Results
```
S44 ON  throughput 42.1M/s  IPC 0.41  L1 miss 5.2%
S44 OFF throughput 2.7M/s   IPC 0.11  L1 miss 61.3%
```

Notes
- Disabling OwnerStash (S44) causes 93.5% throughput collapse and 1090% L1 miss increase.
- The high cycle attribution of S44 is load-bearing work, not removable overhead.

Logs
- `/tmp/s44_ablation_20260119_122513/`

## Native sanity check (Linux, Ryzen 7 5825U)

Env
- CPU: AMD Ryzen 7 5825U (8C/16T)
- OS: Ubuntu 22.04, kernel 6.8.0-90-generic
- gcc: 11.4.0, glibc: 2.35
- commit: 76a0ae82f (S149+)

Results (median)
- random_mixed (T=1, WS=400): 102.9M ops/s, RSS max_kb=18700
- MT remote T=8 R=90: 51.2M ops/s
- MT remote T=16 R=50: 83.2M ops/s
- MT remote T=32 R=90: OOM on 16GB host (excluded)

Notes
- MT remote T=32 was excluded due to OOM (anon-rss ~9.2GB).
- Larson build failed due to `memcached_dtrace.d` in scripts/larson.sh.
